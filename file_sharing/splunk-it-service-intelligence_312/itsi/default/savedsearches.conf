################################
# Health score computation
################################
[service_health_monitor]
action.summary_index = 1
action.summary_index._name = itsi_summary
auto_summarize.dispatch.earliest_time = -45m
cron_schedule = 0-59/1 * * * *
description = Summarizes the health of all services
dispatch.earliest_time = -45m
enableSched = 1
search = `get_itsi_summary_index` `service_level_max_severity_event_only` | stats latest(urgency) AS urgency latest(alert_level) AS alert_level latest(alert_severity) as alert_name latest(service) AS service latest(is_service_in_maintenance) AS is_service_in_maintenance latest(kpi) AS kpi by kpiid, serviceid | gethealth | `gettime`

[Monitor Critical Service Based on HealthScore]
action.email.format = pdf
action.itsi_event_generator = 1
action.itsi_event_generator.param.description = %service_name% is currently in %severity_label% with a value of %severity_value% at %actual_time%
action.itsi_event_generator.param.drilldown_search_earliest_offset = -300
action.itsi_event_generator.param.drilldown_search_latest_offset = 300
action.itsi_event_generator.param.drilldown_search_search = `service_health_data` %itsi_service_id%
action.itsi_event_generator.param.drilldown_search_title = %service_name% health
action.itsi_event_generator.param.drilldown_title = Drilldown to %service_name% health score
action.itsi_event_generator.param.drilldown_uri = /app/itsi/service_detail?serviceId=%itsi_service_id%&earliest=rt-24h&latest=rtnow&kpiId=%kpiid%
action.itsi_event_generator.param.editor = advance_correlation_builder_editor
action.itsi_event_generator.param.meta_data = {}
action.itsi_event_generator.param.owner = unassigned
action.itsi_event_generator.param.search_type = basic
action.itsi_event_generator.param.severity = 4
action.itsi_event_generator.param.status = 0
action.itsi_event_generator.param.title = %service_name% is in %severity_label% - %severity_value%
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
alert.suppress = 0
alert.track = 0
counttype = number of events
cron_schedule = */1 * * * *
description = Monitor Critical service in the environment
disabled = 1
dispatch.earliest_time = -1m
dispatch.latest_time = now
enableSched = 1
quantity = 0
relation = greater than
search = `service_health_data` alert_level=6 | rename serviceid as itsi_service_id | rename kpiid as itsi_kpi_id | rename kpi as kpi_name| lookup service_kpi_lookup _key as itsi_service_id OUTPUT title | rename title as service_name | eval actual_time=_time | convert ctime(actual_time) as actual_time 

##################################################################################################################################
# Disabled Kpis health score generation. The search populates the summary index with 'disabled' state values for all disabled kpis.
##################################################################################################################################
[disabled_kpis_healthscore_generator]
action.summary_index = 1
action.summary_index._name = itsi_summary
auto_summarize.dispatch.earliest_time = -1m
cron_schedule = */1 * * * *
description = Generates Disabled state values for all disabled kpis
dispatch.earliest_time = -1m
enableSched = 1
search = | inputlookup disabled_service_kpi_lookup | rename _key as serviceid title as service_name | eval kpi_info_tmp = mvzip('kpis._key', 'kpis.title', "==@@=="), kpi_info = mvzip(kpi_info_tmp, 'kpis.urgency', "==@@==") | fields kpi_info service_name serviceid enabled | mvexpand kpi_info | rex field=kpi_info "(?<kpiid>.+)==@@==(?<kpi_name>.+)==@@==(?<kpi_urgency>.+)" | fields - kpi_info | where kpi_name!="ServiceHealthScore" | eval search_name="Indicator-Disabled_kpis- ITSI search",entity_key="service_aggregate", entity_title="service_aggregate",is_service_aggregate=1,is_service_max_severity_event="1,0",alert_value="N/A", alert_level=-3, alert_severity="disabled", alert_period=5, alert_color="#CCCCCC", urgency=kpi_urgency, gs_kpi_id=kpiid, gs_service_id=serviceid, itsi_kpi_id=kpiid, indexed_itsi_kpi_id=kpiid, indexed_itsi_service_id=serviceid, is_entity_defined=0, itsi_service_id=serviceid, kpi=kpi_name, color=alert_color, indexed_is_service_aggregate=is_service_aggregate | makemv is_service_max_severity_event delim="," | mvexpand is_service_max_severity_event | Convert num(is_service_max_severity_event) | eval indexed_is_service_max_severity_event=is_service_max_severity_event