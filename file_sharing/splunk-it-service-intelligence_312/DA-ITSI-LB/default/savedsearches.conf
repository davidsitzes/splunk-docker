[DA-ITSI-LB-LoadBalancer_Entity_Search]
description = Search for discovering Load Balancers
search = tag=inventory tag=loadbalancer | eval role="loadbalancer" | stats latest(role) as itsi_role, latest(vendor) as vendor, latest(cpu_count) as cpu_count, latest(version) as version, latest(mem) as memory by host | fields + host, itsi_role, vendor, cpu_count, version, memory
dispatch.earliest_time = -4h
dispatch.latest_time = now
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#  ___                 _                
# |_ _|_ ___ _____ _ _| |_ ___ _ _ _  _ 
#  | || ' \ V / -_) ' \  _/ _ \ '_| || |
# |___|_||_\_/\___|_||_\__\___/_|  \_, |
#                                  |__/ 

[DA-ITSI-LB-LoadBalancer_Inventory]
description = Inventory of Load Balancers
search = host="$host$" tag=inventory tag=loadbalancer (vendor=* OR cpu_count=* OR version=* OR mem=*) \
| stats latest(vendor) as Vendor, latest(cpu_count) as "CPU Cores", latest(version) as Version, latest(mem) as "Memory (GB)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#  __  __ _      _        _             _   
# |  \/  (_)_ _ (_)___ __| |_  __ _ _ _| |_ 
# | |\/| | | ' \| |___/ _| ' \/ _` | '_|  _|
# |_|  |_|_|_||_|_|   \__|_||_\__,_|_|  \__|
#                                           

[DA-ITSI-LB-Loadbalancer_CTX_Performance_CPU]
search = host="$host$" tag=performance tag=loadbalancer tag=cpu cpu_load_percent=* \
| timechart avg(cpu_load_percent) as cpu_pct | eventstats avg(cpu_pct) as average \
| eval _stats = "Average: ".round(average, 1)."%" | fields - average
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Loadbalancer_CTX_Performance_Memory]
search = host="$host$" tag=performance tag=loadbalancer tag=memory (mem_used_percent=* OR mem_usage_percent=*) \
| eval mem_percent=coalesce(mem_used_percent, mem_usage_percent) \
| timechart avg(mem_percent) as mem_pct | eventstats avg(mem_pct) as average \
| eval _stats = "Average: ".round(average, 1)."%" | fields - average
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#   ___                  _            
#  / _ \__ _____ _ ___ _(_)_____ __ __
# | (_) \ V / -_) '_\ V / / -_) V  V /
#  \___/ \_/\___|_|  \_/|_\___|\_/\_/ 
#                                     
[DA-ITSI-LB-Availability]
search = tag=loadbalancer tag=performance host="$host$" avl_status_string=* \
| stats latest(avl_status_string) as latest_availability
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Failover]
search = tag=loadbalancer tag=performance host="$host$" failover_status_string=* \
| stats latest(failover_status_string) as latest_failover
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Concurrent_Sessions]
search = tag=loadbalancer tag=performance tag=network host="$host$" sessions=* \
| timechart avg(sessions) as "Concurrent Sessions"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Upstream_Members]
search = | datamodel LoadBalancer Connections search | search host="$host$"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#   ___ _ _         _   
#  / __| (_)___ _ _| |_ 
# | (__| | / -_) ' \  _|
#  \___|_|_\___|_||_\__|
#                       

[DA-ITSI-LB-Client_Throughput]
search = tag=loadbalancer tag=performance tag=network host="$host$" interface_throughput=* \
| timechart avg(interface_throughput) as throughput | eval throughput = throughput/(1024*1024*1024) | rename throughput as "Client Throughput (GB/s)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Client_Connections]
search = tag=loadbalancer tag=performance tag=network host="$host$" interface_connections=* \
| timechart avg(interface_connections) as "Connections"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Upstream_Top_Clients]
search = tag=loadbalancer tag=performance tag=network host="$host$" interface_connections=* \
| stats latest(interface_connections) as "Connections" by src | rename src as "Client" | sort limit=10 -interface_connections
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-SSL_Transactions_per_Second]
search = tag=loadbalancer tag=performance tag=network host="$host$" ssl_tps=* \
| timechart avg(ssl_tps) as "SSL Transactions per Second"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

# [DA-ITSI-LB-Roundtrip_Times] is a duplicate of the overview Tab.

#  ___                      
# / __| ___ _ ___ _____ _ _ 
# \__ \/ -_) '_\ V / -_) '_|
# |___/\___|_|  \_/\___|_|  
#                           

[DA-ITSI-LB-Server_Connections]
search = tag=loadbalancer tag=performance tag=network host="$host$" vip_connections=* \
| timechart avg(vip_connections) as "Connections"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-5XX_codes]
search = tag=loadbalancer tag=performance tag=network host="$host$" 5XX_codes=* \
| timechart avg(5XX_codes) as "5XX Responses"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-RTT]
search = tag=loadbalancer tag=performance tag=network host="$host$" rtt=* \
| timechart avg(rtt) as "Round Trip Time (ms)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Server_Throughput]
search = tag=loadbalancer tag=performance tag=network host="$host$" vip_throughput=* \
| timechart avg(vip_throughput) as throughput | eval throughput = throughput/(1024*1024*1024) | rename throughput as "Server Throughput (GB/s)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#
# Server Pools
#

[DA-ITSI-LB-Server_Server_Pools_Pools]
search = host="$host$" tag=loadbalancer tag=performance tag=network  pool=* (NOT node=*) | stats latest(avl_status_string) as "Latest Availability" by pool \
| join type=left pool [search host="$host$" tag=loadbalancer tag=performance tag=network tag=loadbalancer_web \
| stats count as "Connections", avg(rtt) as "Round Trip Time (ms)", values(node) as "Members", dc(node) as "Member Count" by pool \
| eval Members = mvjoin(Members,",")] \
| eval "Round Trip Time (ms)" = round('Round Trip Time (ms)',2) | rename pool as Pool \
| table Pool, "Latest Availability", "Connections", "Round Trip Time (ms)", "Member Count", "Members"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-Server_Server_Pools_Members]
search = host="$host$" tag=loadbalancer tag=performance tag=network  node=* (NOT pool=*) | stats latest(avl_status_string) as "Latest Availability" by node \
 | join type=left node [search host="$host$" tag=loadbalancer tag=performance tag=network tag=loadbalancer_web \
 | stats count as "Connections", avg(rtt) as "Round Trip Time (ms)", count(eval(response_code >= 400 AND response_code < 500)) as "4xx Errors", count(eval(response_code >= 500 AND response_code < 600)) as "5xx Errors" by node, pool] \
 | where isnotnull(pool) \
 | eval "Round Trip Time (ms)" = round('Round Trip Time (ms)',2) | rename node as Node, pool as Pool \
 | table Pool, Node, "Latest Availability", "Connections", "Round Trip Time (ms)", "4xx Errors", "5xx Errors"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#  ___ _      _    __
# | _ \ |__ _| |_ / _|___ _ _ _ __  
# |  _/ / _` |  _|  _/ _ \ '_| '  \ 
# |_| |_\__,_|\__|_| \___/_| |_|_|_|
#                                   

[DA-ITSI-LB-System_CPU]
search = host="$host$" tag=performance tag=loadbalancer tag=cpu cpu_load_percent=* \
| timechart eval(round(avg(cpu_load_percent), 2)) as "CPU Load (%)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-System_Memory]
search = host="$host$" tag=performance tag=loadbalancer tag=memory (mem_used_percent=* OR mem_usage_percent=*) \
| eval mem_percent=coalesce(mem_used_percent, mem_usage_percent) | timechart eval(round(avg(mem_percent), 2)) as "Memory Used (%)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-LB-System_Storage]
search = host="$host$" tag=performance tag=loadbalancer tag=storage storage_used_percent=* \
| timechart eval(round(avg(storage_used_percent), 2)) as "Storage Used (%)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#  _  _        _     ___             _      
# | || |___ __| |_  | __|_ _____ _ _| |_ ___
# | __ / _ (_-<  _| | _|\ V / -_) ' \  _(_-<
# |_||_\___/__/\__| |___|\_/\___|_||_\__/__/
#                                           

[DA-ITSI-LB-Loadbalancer_Events]
search = index="*" source="*" host="$host$" tag=loadbalancer
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search
