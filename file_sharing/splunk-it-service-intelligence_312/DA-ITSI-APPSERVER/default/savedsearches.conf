# _______ .__   __. .___________. __  .___________.____    ____
#|   ____||  \ |  | |           ||  | |           |\   \  /   /
#|  |__   |   \|  | `---|  |----`|  | `---|  |----` \   \/   /
#|   __|  |  . `  |     |  |     |  |     |  |       \_    _/
#|  |____ |  |\   |     |  |     |  |     |  |         |  |
#|_______||__| \__|     |__|     |__|     |__|         |__|
#
[DA-ITSI-APPSERVER-ApplicationServer_ApplicationServerInstances_Search]
description = Search for discovering application server instances
search =   tag=appserver tag=inventory ip_address=* application_server=* \
           | eval root_role="application_server"\
           | stats latest(product_family) as product_family, \
            latest(vendor_product) as vendor_product, \
            latest(version_number) as version_number, \
            latest(vendor_product_runtime) as vendor_product_runtime, \
            latest(runtime_vendor) as runtime_vendor, \
            latest(vendor_product_runtime_version) as vendor_product_runtime_version, \
            latest(appserver_port_number) as appserver_port_number, \
            latest(root_role) as itsi_role, \
            latest(full_host_name) as full_host_name, \
            latest(application_server) as application_server \
            by host \
           | eval application_server = if(vendor_product="WebSphere Application Server",ip_address."|".vendor_product."|".appserver_port_number,application_server) \
           | eval product_family_abbreviation = if(like(vendor_product,"Apache%"),"Tomcat","WebSphere") \
           | fields + application_server,itsi_role,vendor_product,version_number,vendor_product_runtime,vendor_product_runtime_version,full_host_name,product_family_abbreviation,product_family
dispatch.earliest_time = -4h
dispatch.latest_time = now
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

# __  .__   __. ____    ____  _______ .__   __. .___________.  ______   .______     ____    ____
#|  | |  \ |  | \   \  /   / |   ____||  \ |  | |           | /  __  \  |   _  \    \   \  /   /
#|  | |   \|  |  \   \/   /  |  |__   |   \|  | `---|  |----`|  |  |  | |  |_)  |    \   \/   /
#|  | |  . `  |   \      /   |   __|  |  . `  |     |  |     |  |  |  | |      /      \_    _/
#|  | |  |\   |    \    /    |  |____ |  |\   |     |  |     |  `--'  | |  |\  \----.   |  |
#|__| |__| \__|     \__/     |_______||__| \__|     |__|      \______/  | _| `._____|   |__|
#
[DA-ITSI-APPSERVER-ApplicationServerInstance_Inventory]
description = Inventory of Application Servers
search = tag=appserver  \
         tag=inventory \
         full_host_name =* \
         application_server="$application_server$" \
        |stats latest(product_family) as product_family, \
               latest(vendor_product) as vendor_product, \
               latest(version_number) as version_number, \
               latest(ip_address) as ip_address
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#.______       __    __  .__   __. .___________. __  .___  ___.  _______
#|   _  \     |  |  |  | |  \ |  | |           ||  | |   \/   | |   ____|
#|  |_)  |    |  |  |  | |   \|  | `---|  |----`|  | |  \  /  | |  |__
#|      /     |  |  |  | |  . `  |     |  |     |  | |  |\/|  | |   __|
#|  |\  \----.|  `--'  | |  |\   |     |  |     |  | |  |  |  | |  |____
#| _| `._____| \______/  |__| \__|     |__|     |__| |__|  |__| |_______|
#
[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Heap_Free_Percentage]
description = Runtime Heap Free Percentage
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(memory_heap_free_percent) as "Memory Heap Free (%)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Heap_Used]
description = Runtime Heap Used
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(memory_heap_used) as "Memory Heap Used (MB)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Heap_Size]
description = Runtime Heap Size
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(memory_heap_size) as "Memory Heap Size (MB)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Active_Threads_Count_Tomcat]
description = Runtime Active Threads Count
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | search thread_id = *  \
         | search thread_state = "active"   \
         | stats count(thread_id) as generated_active_threads_count by _time   \
         | timechart avg(generated_active_threads_count) as "Active Threads (count)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Hung_Threads_Count_Tomcat]
description = Runtime Hung Threads Count
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | search thread_id = *  \
         | search thread_state = "hung"   \
         | stats count(thread_id) as generated_hung_threads_count by _time   \
         | timechart avg(generated_hung_threads_count) as "Hung Threads (count)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Active_Threads_Count_WebSphere]
description = Runtime Active Threads Count
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(active_threads_count) as "Active Threads (count)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Hung_Threads_Count_WebSphere]
description = Runtime Hung Threads Count
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(hung_threads_count) as "Hung Threads (count)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Available_Threads_Percentage]
description = Runtime Available Threads Percentage
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(available_threads_count_percent) as "Available Threads Count (%)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Garbage_Collection_Time]
description = Runtime Garbage Collection Time
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(garbage_collection_time) as "Garbage Collection Time (ms)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Garbage_Collection_Count]
description = Runtime Garbage Collection Count
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(garbage_collection_count) as "Garbage Collections (count)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Perm_Gen_Used]
description = Runtime PermGen Usage
search = tag=appserver  \
         tag=performance  \
         tag=runtime \
         application_server="$application_server$" \
        | timechart avg(perm_gen_usage) as "PermGen Usage (MB)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#____    __    ____  _______ .______
#\   \  /  \  /   / |   ____||   _  \
# \   \/    \/   /  |  |__   |  |_)  |
#  \            /   |   __|  |   _  <
#   \    /\    /    |  |____ |  |_)  |
#    \__/  \__/     |_______||______/
#
[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Active_Sessions_Count]
description = Active Sessions Count
search = tag=appserver  \
         tag=performance \
         tag=session  \
         application_server="$application_server$" \
        | timechart avg(active_sessions_count) as "Active Sessions (count)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Request_Count]
description = Request Count
search = tag=appserver  \
         tag=performance \
         application_server="$application_server$" \
        |timechart avg(request_count) as "Requests (count/min)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Responses_By_Type]
description = Responses by Type
search = tag=appserver  \
         tag=performance \
         application_server="$application_server$" \
        | rangemap field=response_code 2xx=200-299 3xx=300-399 4xx=400-499 5xx=500-599 \
        | search range = * AND NOT(range="None") \
        | timechart count(range) by range
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Client_Failed_Connections]
description = Failed Client Connections
search = tag=appserver  \
         tag=performance \
         application_server="$application_server$" \
        | rangemap field=response_code 4xx=400-499 5xx=500-599 \
        | search range = * AND NOT(range="None") \
        | timechart count(range) by range
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Response_Time_Range]
description = Client Connections Response Time
search = tag=appserver  \
         tag=performance \
         application_server="$application_server$" \
        | timechart avg(response_time) as "Average Transaction Response Time (ms)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search


#  ______ .______    __    __         .___  ___.  _______ .___  ___.
# /      ||   _  \  |  |  |  |        |   \/   | |   ____||   \/   |
#|  ,----'|  |_)  | |  |  |  |  ______|  \  /  | |  |__   |  \  /  |
#|  |     |   ___/  |  |  |  | |______|  |\/|  | |   __|  |  |\/|  |
#|  `----.|  |      |  `--'  |        |  |  |  | |  |____ |  |  |  |
# \______|| _|       \______/         |__|  |__| |_______||__|  |__|
#
[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Memory_Pool_Size]
description = Runtime Memory Pool Size
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
        |timechart avg(memory_pool_size) as "Memory Pool Size (MB)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_Memory_Used]
description = Runtime Memory Pool Size
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(memory_used) as "Memory Used (MB)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-ApplicationServerInstance_Performance_CPU_Utilization_Percentage]
description = Runtime CPU Utilization
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(cpu_utilization_percent) as "CPU Utilization (%)"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

# _______             ______                                  _______
#(_______)           / _____)                                (_______)                 _
# _______ ____  ____( (____  _____  ____ _   _ _____  ____    _____ _   _ _____ ____ _| |_  ___
#|  ___  |  _ \|  _ \\____ \| ___ |/ ___) | | | ___ |/ ___)  |  ___) | | | ___ |  _ (_   _)/___)
#| |   | | |_| | |_| |____) ) ____| |    \ V /| ____| |      | |____\ V /| ____| | | || |_|___ |
#|_|   |_|  __/|  __(______/|_____)_|     \_/ |_____)_|      |_______)_/ |_____)_| |_| \__|___/
#        |_|   |_|
#
[DA-ITSI-APPSERVER-ApplicationServer_Events]
description = All Events Related to Application Server
search = tag=appserver \
         application_server="$application_server$"
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#.___  ___.  __  .__   __.  __    ______  __    __       ___      .______     .___________.    _______.
#|   \/   | |  | |  \ |  | |  |  /      ||  |  |  |     /   \     |   _  \    |           |   /       |
#|  \  /  | |  | |   \|  | |  | |  ,----'|  |__|  |    /  ^  \    |  |_)  |   `---|  |----`  |   (----`
#|  |\/|  | |  | |  . `  | |  | |  |     |   __   |   /  /_\  \   |      /        |  |        \   \
#|  |  |  | |  | |  |\   | |  | |  `----.|  |  |  |  /  _____  \  |  |\  \----.   |  |    .----)   |
#|__|  |__| |__| |__| \__| |__|  \______||__|  |__| /__/     \__\ | _| `._____|   |__|    |_______/
#
[DA-ITSI-APPSERVER-Context_Chart_CPU_Utilization_Percentage]
description = Runtime CPU Utilization
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(cpu_utilization_percent) as cpu_util_pct  \
         | eventstats avg(cpu_util_pct) as average \
         | eval _stats = "Average: ".round(average, 1)."%"  \
         | fields - average
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-Context_Chart_Heap_Free_Percentage]
description = Runtime Heap Free Percentage
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(memory_heap_free_percent) as mem_heap_free_pct  \
         | eventstats avg(mem_heap_free_pct) as average  \
         | eval _stats = "Average: ".round(average, 1)."%"  \
         | fields - average
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-Context_Chart_Available_Threads_Percentage]
description = Runtime Available Threads Percentage
search = tag=appserver  \
         tag=performance \
         tag=runtime  \
         application_server="$application_server$" \
         | timechart avg(available_threads_count_percent) as fr_thrds_cnt_pct \
         | eventstats avg(fr_thrds_cnt_pct) as average  \
         | eval _stats = "Average: ".round(average, 1)."%"  \
         | fields - average
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-APPSERVER-Context_Chart_Error_Code_Percentage]
description = Runtime Available Threads Percentage
search = tag=appserver  \
         tag=performance  \
         application_server="$application_server$" \
         | search response_code = *  \
         | eval is_error_code=if(response_code>399 AND response_code<599,1,0)  \
         | stats count as total_count  \
           sum(is_error_code) as error_code_count  \
           by _time  \
         | eval error_pct = round((error_code_count/total_count*100),2)  \
         | timechart avg(error_pct) as error_pct  \
         | eventstats avg(error_pct) as average  \
         | eval _stats = "Average: ".round(average, 1)."%"  \
         | fields - average
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search
